<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AV Monitoring — Devices (Agent {{ site.id }})</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .muted { color:#666; font-size: 12px; }
    a { text-decoration:none; }
    a:hover { text-decoration:underline; }
    code { background:#f4f4f4; padding:2px 6px; border-radius:4px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background:#fafafa; text-align:left; }
    .section { margin-top: 18px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .ok { color:#1b5e20; font-weight:700; }
    .warn { color:#b26a00; font-weight:700; }
    .bad { color:#b00020; font-weight:700; }
  </style>
</head>
<body>
  <p><a href="/ui/agents">← Retour agents</a></p>

  <h1>Devices — Agent/Site {{ site.id }} (<code>{{ site.name }}</code>)</h1>
  <p class="muted">Tri : Bâtiment → Salle → IP. Cliquez sur l’ID pour le détail (metrics, uptime lisible).</p>

  {% for building, rooms in grouped.items() %}
    <div class="section">
      <h2>Bâtiment : {{ building }}</h2>

      {% for room, devices in rooms.items() %}
        <h3>Salle : {{ room }}</h3>

        <table>
          <tr>
            <th>ID</th>
            <th>Nom</th>
            <th>IP</th>
            <th>Type</th>
            <th>Driver</th>
            <th>Status</th>
            <th>Détail</th>
            <th>Uptime</th>
            <th>sysDescr (court)</th>
            <th>Last seen (UTC)</th>
          </tr>

          {% for d in devices %}
          {% set m = d.metrics or {} %}
          <tr>
            <td><a href="/ui/devices/{{ d.id }}">{{ d.id }}</a></td>
            <td>{{ d.name }}</td>
            <td><code>{{ d.ip }}</code></td>
            <td>{{ d.device_type }}</td>
            <td><span class="pill">{{ d.driver }}</span></td>
            <td>
              {% if d.status == "online" %}
                <span class="ok">online</span>
              {% elif d.status == "offline" %}
                <span class="bad">offline</span>
              {% else %}
                <span class="warn">{{ d.status }}</span>
              {% endif %}
            </td>
            <td><code>{{ d.detail or "—" }}</code></td>
            <td>{{ m.uptime_human or "—" }}</td>
            <td class="muted" style="max-width:420px;">{{ m.sys_descr_short or "—" }}</td>
            <td class="muted">{{ d.last_seen or "—" }}</td>
          </tr>
          {% endfor %}
        </table>
      {% endfor %}
    </div>
  {% endfor %}
</body>
</html>