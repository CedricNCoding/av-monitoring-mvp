<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AV Monitoring ‚Äî Device {{ device.id }}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --danger: #ef4444;
      --danger-bg: #fef2f2;
      --success: #10b981;
      --success-bg: #f0fdf4;
      --warning: #f59e0b;
      --warning-bg: #fffbeb;
      --violet: #7c3aed;
      --violet-bg: #f5f3ff;
      --dark-code: #0f172a;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      margin: 0;
      padding: 24px;
      line-height: 1.5;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    /* Header & Nav */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 20px;
      transition: color 0.2s;
      font-weight: 600;
    }
    .back-link:hover { color: var(--primary); text-decoration: underline; }

    header {
      margin-bottom: 18px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    h1 { font-size: 26px; font-weight: 900; margin: 0; letter-spacing: -0.025em; }
    .subtitle { color: var(--text-muted); font-size: 13px; margin-top: 4px; }

    /* Layout Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 18px; margin-top: 18px; }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    h2 { font-size: 16px; font-weight: 900; margin: 0 0 14px 0; display: flex; align-items: center; gap: 8px; }

    /* Tables */
    table { border-collapse: collapse; width: 100%; }
    th {
      text-align: left;
      font-size: 12px;
      font-weight: 800;
      color: var(--text-muted);
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9;
      width: 180px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    td { padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 14px; font-weight: 600; }
    tr:last-child th, tr:last-child td { border-bottom: none; }

    /* Elements */
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 6px; color: var(--primary); font-size: 0.9em; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .muted { color: var(--text-muted); font-size: 13px; font-weight: 500; }

    pre {
      background: var(--dark-code);
      color: #94a3b8;
      padding: 16px;
      border-radius: 14px;
      overflow: auto;
      font-size: 13px;
      line-height: 1.6;
      border: 1px solid #334155;
      margin: 0;
    }

    /* Badges */
    .pill {
      background: #f1f5f9;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text-muted);
      border: 1px solid var(--border);
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid var(--border);
      width: fit-content;
    }

    .dot { width: 8px; height: 8px; border-radius: 999px; display:inline-block; }

    .badge.ok { border-color: var(--success); color: var(--success); background: var(--success-bg); }
    .badge.fault { border-color: var(--danger); color: var(--danger); background: var(--danger-bg); }
    .badge.expected_off { border-color: var(--warning); color: var(--warning); background: var(--warning-bg); }
    .badge.doubt { border-color: var(--violet); color: var(--violet); background: var(--violet-bg); }
    .badge.unknown { border-color: var(--border); color: var(--text-muted); background: #f8fafc; }

    .dot.ok { background: var(--success); }
    .dot.fault { background: var(--danger); }
    .dot.expected_off { background: var(--warning); }
    .dot.doubt { background: var(--violet); }
    .dot.unknown { background: var(--text-muted); }

    .error-text { color: var(--danger); font-weight: 700; }
    .soft { font-weight: 600; color: var(--text-main); }
  </style>
</head>
<body>
  <div class="container">
    <a href="/ui/agents/{{ device.site_id }}/devices" class="back-link">‚Üê Retour aux √©quipements du site</a>

    {% set verdict = (device.verdict or "")|lower %}
    {% set status = (device.status or "")|lower %}

    <header>
      <div>
        <h1>Device #{{ device.id }}</h1>
        <div class="subtitle">Diagnostic d√©taill√© et m√©triques (si disponibles)</div>
      </div>

      <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
        <span class="pill">Driver: <span class="mono">{{ device.driver or "‚Äî" }}</span></span>

        {# Badge global : verdict > status #}
        {% if verdict == "ok" %}
          <span class="badge ok"><span class="dot ok"></span> ok</span>
        {% elif verdict == "fault" %}
          <span class="badge fault"><span class="dot fault"></span> fault</span>
        {% elif verdict == "expected_off" %}
          <span class="badge expected_off"><span class="dot expected_off"></span> expected_off</span>
        {% elif verdict == "doubt" %}
          <span class="badge doubt"><span class="dot doubt"></span> doubt</span>
        {% else %}
          {% if status == "online" %}
            <span class="badge ok"><span class="dot ok"></span> online</span>
          {% elif status == "offline" %}
            <span class="badge fault"><span class="dot fault"></span> offline</span>
          {% else %}
            <span class="badge unknown"><span class="dot unknown"></span> {{ device.status or "unknown" }}</span>
          {% endif %}
        {% endif %}
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>üìÇ Inventaire</h2>
        <table>
          <tr><th>Localisation</th><td class="soft">{{ device.building or "‚Äî" }} / {{ device.room or "‚Äî" }}</td></tr>
          <tr><th>Nom</th><td class="soft">{{ device.name or "‚Äî" }}</td></tr>
          <tr><th>Adresse IP</th><td><code>{{ device.ip or "‚Äî" }}</code></td></tr>
          <tr><th>Type</th><td class="soft">{{ device.device_type or "‚Äî" }}</td></tr>
          <tr><th>Site ID</th><td><code>{{ device.site_id }}</code></td></tr>
        </table>
      </div>

      <div class="card">
        <h2>‚ö° √âtat & Observations</h2>
        <table>
          <tr>
            <th>Status brut</th>
            <td class="soft">{{ device.status or "‚Äî" }}</td>
          </tr>
          <tr>
            <th>Verdict</th>
            <td class="soft">{{ device.verdict or "‚Äî" }}</td>
          </tr>
          <tr>
            <th>D√©tail</th>
            <td>
              {% if device.detail %}
                <span class="mono error-text">{{ device.detail }}</span>
              {% else %}
                <span class="muted">‚Äî</span>
              {% endif %}
            </td>
          </tr>
          <tr><th>Last seen (UTC)</th><td class="muted mono">{{ device.last_seen or "‚Äî" }}</td></tr>
          <tr><th>Last OK (UTC)</th><td class="muted mono">{{ device.last_ok_at or "‚Äî" }}</td></tr>
          <tr><th>Uptime</th><td class="soft" style="color:var(--primary)">{{ (metrics.uptime_human if metrics and metrics.uptime_human else "‚Äî") }}</td></tr>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top: 18px;">
      <h2>üîç D√©tails driver / m√©triques</h2>

      {% if device.driver == "snmp" %}
        {# M√©triques SNMP #}
        {% set snmp_ok = (metrics.snmp_ok if metrics and metrics.snmp_ok is not none else none) %}
        {% set sys_descr = (metrics.sys_descr if metrics and metrics.sys_descr else "") %}
        {% set sys_uptime = (metrics.sys_uptime if metrics and metrics.sys_uptime is not none else none) %}

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 22px;">
          <table>
            <tr>
              <th>sysDescr</th>
              <td class="muted" style="line-height: 1.4;">{{ sys_descr or "‚Äî" }}</td>
            </tr>
            <tr>
              <th>SNMP OK</th>
              <td class="soft">
                {% if snmp_ok is none %}
                  <span class="muted">‚Äî</span>
                {% else %}
                  {{ "‚úÖ Oui" if snmp_ok else "‚ùå Non" }}
                {% endif %}
              </td>
            </tr>
          </table>
          <table>
            <tr><th>sysUpTime</th><td class="muted mono">{{ sys_uptime if sys_uptime is not none else "‚Äî" }}</td></tr>
            <tr><th>SNMP port</th><td><code>{{ (metrics.snmp_port if metrics and metrics.snmp_port else "161") }}</code></td></tr>
            <tr>
              <th>Erreur</th>
              <td class="muted">
                {% if metrics and metrics.get and metrics.get("snmp_error") %}
                  <span class="mono error-text">{{ metrics.get("snmp_error") }}</span>
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
          </table>
        </div>

      {% elif device.driver == "pjlink" %}
        {# M√©triques PJLink #}
        {% set pjlink_ok = (metrics.pjlink_ok if metrics and metrics.pjlink_ok is not none else none) %}
        {% set power_status = (metrics.power_status if metrics and metrics.power_status else "") %}

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 22px;">
          <table>
            <tr>
              <th>PJLink OK</th>
              <td class="soft">
                {% if pjlink_ok is none %}
                  <span class="muted">‚Äî</span>
                {% else %}
                  {{ "‚úÖ Oui" if pjlink_ok else "‚ùå Non" }}
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Power Status</th>
              <td class="soft">{{ power_status or "‚Äî" }}</td>
            </tr>
          </table>
          <table>
            <tr><th>PJLink port</th><td><code>{{ (metrics.pjlink_port if metrics and metrics.pjlink_port else "4352") }}</code></td></tr>
            <tr>
              <th>Erreur</th>
              <td class="muted">
                {% if metrics and metrics.get and metrics.get("pjlink_error") %}
                  <span class="mono error-text">{{ metrics.get("pjlink_error") }}</span>
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
          </table>
        </div>

      {% elif device.driver == "ping" %}
        {# M√©triques Ping #}
        {% set ping_ok = (metrics.ping_ok if metrics and metrics.ping_ok is not none else none) %}
        {% set ping_ms = (metrics.ping_ms if metrics and metrics.ping_ms is not none else none) %}

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 22px;">
          <table>
            <tr>
              <th>Ping r√©ponse</th>
              <td class="soft">
                {% if ping_ok is none %}
                  <span class="muted">‚Äî</span>
                {% else %}
                  {{ "‚úÖ Oui" if ping_ok else "‚ùå Non" }}
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Latence</th>
              <td class="soft">
                {% if ping_ms is not none %}
                  <strong>{{ ping_ms }} ms</strong>
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
          </table>
          <table>
            <tr>
              <th>Erreur</th>
              <td class="muted">
                {% if metrics and metrics.get and metrics.get("ping_error") %}
                  <span class="mono error-text">{{ metrics.get("ping_error") }}</span>
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
          </table>
        </div>

      {% else %}
        <div class="muted" style="text-align: center; padding: 40px;">
          Driver inconnu: <code>{{ device.driver }}</code>
        </div>
      {% endif %}
    </div>

    <!-- Historique et Disponibilit√© -->
    <div class="grid" style="margin-top: 18px;">
      <div class="card">
        <h2>üìä Historique (30 derniers jours)</h2>
        <canvas id="historyChart" style="max-height: 300px;"></canvas>
      </div>

      <div class="card">
        <h2>üìà Disponibilit√© (30 derniers jours)</h2>
        <div id="uptimeStats" style="text-align: center; padding: 20px;">
          <div class="muted">Chargement...</div>
        </div>
      </div>
    </div>

    <div style="margin-top: 22px;">
      <h2 class="muted" style="margin: 0 0 8px 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em;">
        Donn√©es brutes (JSON)
      </h2>
      <pre>{{ metrics_json }}</pre>
    </div>
  </div>

  <script>
  // Charger l'historique du device
  const deviceId = {{ device.id }};

  // Fetch history data
  fetch(`/api/devices/${deviceId}/history?days=30`)
    .then(res => res.json())
    .then(data => {
      if (!data.events || data.events.length === 0) {
        document.getElementById('historyChart').parentElement.innerHTML =
          '<h2>üìä Historique (30 derniers jours)</h2><div style="text-align:center; padding:40px; color:var(--text-muted);">Aucun √©v√©nement enregistr√©</div>';
        return;
      }

      // Pr√©parer les donn√©es pour Chart.js
      const labels = data.events.map(e => {
        const date = new Date(e.timestamp);
        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }) + ' ' +
               date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      });

      const statusData = data.events.map(e => {
        // Convertir status en valeur num√©rique pour le graphique
        if (e.status === 'online') return 1;
        if (e.status === 'offline') return 0;
        return 0.5; // unknown
      });

      const backgroundColors = data.events.map(e => {
        if (e.status === 'online') return 'rgba(34, 197, 94, 0.2)';
        if (e.status === 'offline') return 'rgba(239, 68, 68, 0.2)';
        return 'rgba(148, 163, 184, 0.2)';
      });

      const borderColors = data.events.map(e => {
        if (e.status === 'online') return 'rgba(34, 197, 94, 1)';
        if (e.status === 'offline') return 'rgba(239, 68, 68, 1)';
        return 'rgba(148, 163, 184, 1)';
      });

      // Cr√©er le graphique
      const ctx = document.getElementById('historyChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Status',
            data: statusData,
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.1,
            pointBackgroundColor: backgroundColors,
            pointBorderColor: borderColors,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const event = data.events[context.dataIndex];
                  let label = 'Status: ' + event.status;
                  if (event.verdict) {
                    label += ' | Verdict: ' + event.verdict;
                  }
                  if (event.detail) {
                    label += ' | ' + event.detail;
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 1,
              ticks: {
                callback: function(value) {
                  if (value === 1) return 'Online';
                  if (value === 0) return 'Offline';
                  return 'Unknown';
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                maxTicksLimit: 20
              }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error('Erreur chargement historique:', err);
      document.getElementById('historyChart').parentElement.innerHTML =
        '<h2>üìä Historique (30 derniers jours)</h2><div style="text-align:center; padding:40px; color:var(--danger);">Erreur de chargement</div>';
    });

  // Fetch uptime data
  fetch(`/api/devices/${deviceId}/uptime?days=30`)
    .then(res => res.json())
    .then(data => {
      const uptimePercent = data.uptime_percent || 0;
      const color = uptimePercent >= 95 ? 'var(--success)' : (uptimePercent >= 80 ? 'var(--warning)' : 'var(--danger)');

      document.getElementById('uptimeStats').innerHTML = `
        <div style="font-size: 48px; font-weight: 900; color: ${color}; margin-bottom: 12px;">
          ${uptimePercent}%
        </div>
        <div class="muted" style="margin-bottom: 20px;">Taux de disponibilit√© sur 30 jours</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; text-align: center; margin-top: 20px;">
          <div>
            <div style="font-size: 24px; font-weight: 700; color: var(--text-main);">${data.total_events}</div>
            <div class="muted" style="font-size: 12px;">√âv√©nements</div>
          </div>
          <div>
            <div style="font-size: 24px; font-weight: 700; color: var(--success);">${data.online_events}</div>
            <div class="muted" style="font-size: 12px;">Online</div>
          </div>
          <div>
            <div style="font-size: 24px; font-weight: 700; color: var(--danger);">${data.offline_events}</div>
            <div class="muted" style="font-size: 12px;">Offline</div>
          </div>
        </div>
      `;
    })
    .catch(err => {
      console.error('Erreur chargement uptime:', err);
      document.getElementById('uptimeStats').innerHTML =
        '<div style="color: var(--danger);">Erreur de chargement des statistiques</div>';
    });
  </script>
</body>
</html>