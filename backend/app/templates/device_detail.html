<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AV Monitoring — Device #{{ device.id }}</title>
  <style>
    :root{
      --primary:#2563eb;
      --primary-hover:#1d4ed8;
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: 0 8px 20px rgba(2, 8, 23, 0.06);
      --shadow-sm: 0 1px 3px rgba(2, 8, 23, 0.08);

      --ok:#10b981;
      --fault:#ef4444;
      --expected:#0ea5e9;
      --doubt:#f59e0b;
      --unknown:#94a3b8;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --radius: 14px;

      --code-bg:#0b1220;
      --code-border:#1f2a44;
      --code-fg:#cbd5e1;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:24px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.5;
    }

    .container{ max-width:1200px; margin:0 auto; }

    .back{
      display:inline-flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.6);
      box-shadow:var(--shadow-sm);
      transition:transform .12s ease, color .12s ease;
      margin-bottom:14px;
    }
    .back:hover{ transform:translateY(-1px); color:var(--primary); }

    h1{
      margin:0;
      font-size:24px;
      font-weight:950;
      letter-spacing:-0.02em;
    }
    .subtitle{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:13px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:16px;
    }

    .mono{ font-family:var(--mono); }
    code{
      font-family:var(--mono);
      font-size:13px;
      background:#f1f5f9;
      padding:4px 8px;
      border-radius:10px;
      border:1px solid #e6edf6;
      color:var(--primary);
      font-weight:900;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:950;
      border:1px solid var(--border);
      background:#ffffff;
      color:var(--muted);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap:14px;
      margin-top:10px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .card h2{
      margin:0 0 12px 0;
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    th, td{
      padding:10px 0;
      border-bottom:1px solid #f1f5f9;
      text-align:left;
      vertical-align:top;
    }

    th{
      width:180px;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.06em;
    }

    tr:last-child th, tr:last-child td{ border-bottom:none; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:6px 10px;
      font-weight:950;
      font-size:12px;
      border:1px solid var(--border);
      background:#ffffff;
      white-space:nowrap;
    }
    .badge .dot{ width:8px; height:8px; border-radius:999px; background:var(--unknown); }

    .badge.ok{ border-color: rgba(16,185,129,0.25); background: rgba(16,185,129,0.08); color:#065f46; }
    .badge.ok .dot{ background:var(--ok); }

    .badge.fault{ border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.08); color:#7f1d1d; }
    .badge.fault .dot{ background:var(--fault); }

    .badge.expected_off{ border-color: rgba(14,165,233,0.25); background: rgba(14,165,233,0.08); color:#075985; }
    .badge.expected_off .dot{ background:var(--expected); }

    .badge.doubt{ border-color: rgba(245,158,11,0.25); background: rgba(245,158,11,0.10); color:#7c2d12; }
    .badge.doubt .dot{ background:var(--doubt); }

    .badge.unknown{ border-color: rgba(148,163,184,0.35); background: rgba(148,163,184,0.10); color:#334155; }
    .badge.unknown .dot{ background:var(--unknown); }

    .muted{ color:var(--muted); font-size:13px; }
    .warn{ color:#7c2d12; font-weight:800; }
    .danger{ color:#7f1d1d; font-weight:900; }

    .metrics-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .kv{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#ffffff;
    }
    .kv .k{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.06em;
      margin-bottom:6px;
    }
    .kv .v{
      font-family:var(--mono);
      font-size:13px;
      color:var(--text);
      word-break:break-word;
    }

    pre{
      background:var(--code-bg);
      border:1px solid var(--code-border);
      color:var(--code-fg);
      padding:16px;
      border-radius:var(--radius);
      overflow:auto;
      font-size:13px;
      line-height:1.6;
      box-shadow:var(--shadow);
      margin-top:10px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .metrics-grid{ grid-template-columns: 1fr; }
      th{ width: 150px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a class="back" href="/ui/agents/{{ device.site_id }}/devices">← Retour aux équipements du site</a>

    {% set verdict = device.verdict or (metrics.get('verdict') if metrics else '') or 'unknown' %}

    <div class="header">
      <div>
        <h1>Device #{{ device.id }} <span class="mono" style="color:var(--muted); font-weight:900;">({{ device.name }})</span></h1>
        <div class="subtitle">Diagnostic détaillé et métriques. Driver : <code>{{ device.driver }}</code></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">Site <code>{{ device.site_id }}</code></span>
        <span class="pill">IP <code>{{ device.ip }}</code></span>

        {% if verdict == "ok" %}
          <span class="badge ok"><span class="dot"></span>verdict: ok</span>
        {% elif verdict == "fault" %}
          <span class="badge fault"><span class="dot"></span>verdict: fault</span>
        {% elif verdict == "expected_off" %}
          <span class="badge expected_off"><span class="dot"></span>verdict: expected_off</span>
        {% elif verdict == "doubt" %}
          <span class="badge doubt"><span class="dot"></span>verdict: doubt</span>
        {% else %}
          <span class="badge unknown"><span class="dot"></span>verdict: unknown</span>
        {% endif %}
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Inventaire</h2>
        <table>
          <tr><th>Nom</th><td><strong>{{ device.name }}</strong></td></tr>
          <tr><th>Adresse IP</th><td><code>{{ device.ip }}</code></td></tr>
          <tr><th>Type</th><td>{{ device.device_type or "—" }}</td></tr>
          <tr><th>Driver</th><td><code>{{ device.driver }}</code></td></tr>
          <tr><th>Localisation</th><td>{{ device.building or "—" }} / {{ device.room or "—" }}</td></tr>
        </table>
      </div>

      <div class="card">
        <h2>État & Télémetrie</h2>
        <table>
          <tr>
            <th>Status</th>
            <td>
              {% if device.status == "online" %}
                <span class="badge ok"><span class="dot"></span>online</span>
              {% elif device.status == "offline" %}
                <span class="badge fault"><span class="dot"></span>offline</span>
              {% else %}
                <span class="badge unknown"><span class="dot"></span>{{ device.status }}</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <th>Détail</th>
            <td>
              {% if device.detail %}
                <span class="mono danger">{{ device.detail }}</span>
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
          </tr>
          <tr><th>Last seen (UTC)</th><td class="mono muted">{{ device.last_seen or "—" }}</td></tr>
          <tr><th>Last OK (UTC)</th><td class="mono muted">{{ device.last_ok_at or "—" }}</td></tr>
          <tr><th>Uptime</th><td><span class="mono" style="font-weight:900; color:var(--primary);">{{ metrics.uptime_human or "—" }}</span></td></tr>
          <tr><th>sysDescr</th><td class="muted">{{ metrics.sys_descr or metrics.sys_descr_short or "—" }}</td></tr>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Métriques (principales)</h2>

      {% set keys = [] %}
      {# on affiche un set “commun” + fallback keys arbitraires #}
      <div class="metrics-grid">
        <div class="kv">
          <div class="k">snmp_ok</div>
          <div class="v">{{ (metrics.get("snmp_ok") if metrics else None) or "—" }}</div>
        </div>
        <div class="kv">
          <div class="k">pjlink_ok</div>
          <div class="v">{{ (metrics.get("pjlink_ok") if metrics else None) or "—" }}</div>
        </div>
        <div class="kv">
          <div class="k">verdict</div>
          <div class="v">{{ verdict }}</div>
        </div>
        <div class="kv">
          <div class="k">detail</div>
          <div class="v">{{ device.detail or "—" }}</div>
        </div>
      </div>

      <div style="margin-top:12px;" class="muted">
        Remarque : les métriques sont génériques (SNMP, PJLink, ping, etc.). La section JSON ci-dessous reste la référence.
      </div>
    </div>

    <div style="margin-top:16px;">
      <div class="muted" style="font-weight:950; text-transform:uppercase; letter-spacing:0.08em; font-size:12px;">
        Données brutes (JSON)
      </div>
      <pre>{{ metrics_json }}</pre>
    </div>
  </div>
</body>
</html>