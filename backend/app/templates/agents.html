<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AV Monitoring — Agents</title>
  <style>
    :root{
      --primary:#2563eb;
      --primary-hover:#1d4ed8;
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: 0 10px 20px rgba(2,6,23,.06);
      --shadow-sm: 0 4px 10px rgba(2,6,23,.06);
      --ring: 0 0 0 4px rgba(37,99,235,.15);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 28px;
    }

    a{color:inherit}
    .container{max-width:1100px; margin:0 auto;}

    /* Top bar */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .title h1{
      margin:0;
      font-size:28px;
      font-weight:850;
      letter-spacing:-0.02em;
    }
    .title p{margin:6px 0 0 0; color:var(--muted); max-width: 70ch;}
    .nav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .nav a{
      text-decoration:none;
      padding:10px 12px;
      border:1px solid var(--border);
      background: var(--card);
      border-radius:10px;
      box-shadow: var(--shadow-sm);
      font-weight:650;
      font-size:13px;
      color: var(--text);
      transition: .15s ease;
    }
    .nav a:hover{transform: translateY(-1px); border-color:#cbd5e1}
    .nav a:focus{outline:none; box-shadow: var(--ring);}

    /* KPI cards */
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
      margin: 18px 0 18px;
    }
    .kpi{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: var(--shadow-sm);
      padding:14px 14px;
      min-height: 88px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi .label{color:var(--muted); font-size:12px; font-weight:700; letter-spacing:.06em; text-transform:uppercase;}
    .kpi .value{font-size:26px; font-weight:850; letter-spacing:-.02em; margin-top:6px;}
    .kpi .hint{color:var(--muted); font-size:13px; margin-top:2px;}

    /* Toolbar */
    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .search{
      flex: 1 1 320px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search input{
      width:100%;
      padding: 12px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background: var(--card);
      font-size:14px;
      outline:none;
      transition: .15s ease;
    }
    .search input:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: var(--ring);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      color: var(--primary);
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }

    /* Table */
    .table-wrap{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    thead th{
      background: #fcfcfd;
      padding: 14px 16px;
      text-align:left;
      font-size:12px;
      font-weight:800;
      color: var(--muted);
      border-bottom:1px solid var(--border);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    tbody td{
      padding: 14px 16px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      font-size:14px;
    }
    tbody tr:hover{background:#f8fafc;}
    tbody tr:last-child td{border-bottom:none;}

    .site-id{color:var(--muted); font-weight:700; font-size:13px;}
    code{
      background:#f1f5f9;
      padding: 4px 8px;
      border-radius: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      color: var(--primary);
      font-weight:650;
    }
    .count{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 44px;
      padding: 4px 10px;
      border-radius: 999px;
      background:#eff6ff;
      color: var(--primary);
      font-weight:900;
      font-size: 13px;
    }
    .muted{color:var(--muted);}
    .actions{
      text-align:right;
      white-space:nowrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 12px;
      text-decoration:none;
      font-weight:800;
      font-size: 13px;
      border:1px solid transparent;
      transition:.15s ease;
    }
    .btn.primary{
      background: var(--primary);
      color:#fff;
    }
    .btn.primary:hover{
      background: var(--primary-hover);
      box-shadow: 0 10px 18px rgba(37,99,235,.18);
      transform: translateY(-1px);
    }
    .btn:focus{outline:none; box-shadow: var(--ring);}

    /* Empty state */
    .empty{
      padding: 28px 18px;
      text-align:center;
    }
    .empty h2{
      margin:0 0 8px 0;
      font-size:18px;
      font-weight:850;
      letter-spacing:-.01em;
    }
    .empty p{margin:0; color:var(--muted);}

    /* Footer */
    footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    @media (max-width: 820px){
      body{padding:18px}
      .kpis{grid-template-columns: 1fr;}
      .actions{text-align:left;}
      thead{display:none;}
      table, tbody, tr, td{display:block; width:100%;}
      tbody td{border-bottom:none; padding: 10px 14px;}
      tbody tr{border-bottom:1px solid var(--border);}
      tbody td[data-label]::before{
        content: attr(data-label);
        display:block;
        color: var(--muted);
        font-size: 12px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: .08em;
        margin-bottom: 4px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="title">
        <h1>Agents (Sites)</h1>
        <p>Chaque agent déployé supervise un site local. Sélectionnez un site pour consulter ses équipements, leurs états et les métriques.</p>
      </div>
      <nav class="nav" aria-label="Navigation">
        <a href="/ui/agents" aria-current="page">Agents</a>
        <a href="/devices" title="API JSON">API /devices</a>
        <a href="/health" title="Healthcheck">Health</a>
      </nav>
    </div>

    {% set total_sites = (sites | length) %}
    {% set total_devices = 0 %}
    {% for s in sites %}
      {% set total_devices = total_devices + (s.device_count or 0) %}
    {% endfor %}

    <section class="kpis" aria-label="Synthèse">
      <div class="kpi">
        <div class="label">Sites</div>
        <div class="value">{{ total_sites }}</div>
        <div class="hint">Agents enregistrés</div>
      </div>
      <div class="kpi">
        <div class="label">Équipements</div>
        <div class="value">{{ total_devices }}</div>
        <div class="hint">Total inventorié</div>
      </div>
      <div class="kpi">
        <div class="label">Accès</div>
        <div class="value" style="font-size:18px; font-weight:850;">/ui/agents</div>
        <div class="hint">Vue opérateur</div>
      </div>
    </section>

    <div class="toolbar">
      <div class="search">
        <input id="q" type="text" placeholder="Rechercher un site (nom, id)…" autocomplete="off" />
        <span class="pill" id="counter">{{ total_sites }} site(s)</span>
      </div>
      <div class="muted" style="font-size:13px;">
        Conseil : créez un site via <code>/admin/create-site</code>
      </div>
    </div>

    <div class="table-wrap">
      {% if sites|length == 0 %}
        <div class="empty">
          <h2>Aucun site enregistré</h2>
          <p>Créez un site (agent) puis configurez l’agent avec <code>site_name</code> et <code>site_token</code>.</p>
        </div>
      {% else %}
        <table aria-label="Liste des sites">
          <thead>
            <tr>
              <th style="width:110px;">ID</th>
              <th>Nom du Site / Agent</th>
              <th style="width:160px;">Équipements</th>
              <th style="width:170px; text-align:right;">Action</th>
            </tr>
          </thead>
          <tbody id="rows">
            {% for s in sites %}
              <tr class="row"
                  data-id="{{ s.id }}"
                  data-name="{{ (s.name or '') | lower }}">
                <td class="site-id" data-label="ID">#{{ s.id }}</td>
                <td data-label="Site"><code>{{ s.name }}</code></td>
                <td data-label="Équipements">
                  <span class="count">{{ s.device_count }}</span>
                  <span class="muted" style="margin-left:8px;">unités</span>
                </td>
                <td class="actions" data-label="Action">
                  <a href="/ui/agents/{{ s.id }}/devices" class="btn primary">Explorer</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>

    <footer>
      <div>AV Monitoring MVP — Backend UI</div>
      <div>Astuce: utilisez <code>curl -u ...</code> si Traefik protège par BasicAuth.</div>
    </footer>
  </div>

  <script>
    (function(){
      const q = document.getElementById('q');
      const rows = Array.from(document.querySelectorAll('#rows tr.row'));
      const counter = document.getElementById('counter');

      function apply(){
        const needle = (q.value || '').trim().toLowerCase();
        let visible = 0;

        rows.forEach(tr => {
          const id = (tr.getAttribute('data-id') || '').toLowerCase();
          const name = (tr.getAttribute('data-name') || '').toLowerCase();
          const ok = !needle || id.includes(needle) || name.includes(needle);
          tr.style.display = ok ? '' : 'none';
          if(ok) visible += 1;
        });

        counter.textContent = visible + ' site(s)';
      }

      if(q){
        q.addEventListener('input', apply);
        apply();
      }
    })();
  </script>
</body>
</html>